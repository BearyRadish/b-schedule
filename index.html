<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BåŒºæ’ç­ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .staff-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .staff-item:hover { background: #e8e8e8; }
        .staff-item.selected { background: #667eea; color: white; }
        .staff-item.sick { background: #ffebee; color: #c62828; }
        .staff-item.vacation { background: #fff3e0; color: #ef6c00; }
        .staff-item input { margin-right: 8px; }
        .btn {
            display: inline-block;
            padding: 14px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            margin-left: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #667eea;
            color: white;
        }
        .time-slot { font-weight: 600; color: #667eea; }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-duty { background: #e3f2fd; color: #1976d2; }
        .badge-cleaning { background: #e8f5e9; color: #388e3c; }
        .badge-inventory { background: #f3e5f5; color: #7b1fa2; }
        .badge-break { background: #fff3e0; color: #f57c00; }
        .badge-parttime { color: #666; font-style: italic; }
        #scheduleOutput { margin-top: 30px; }
        .share-box {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .share-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
        }
        .tab.active { background: #667eea; color: white; }
        .view { display: none; }
        .view.active { display: block; }
        .schedule-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .schedule-time { font-weight: 600; color: #667eea; }
        .shift-group-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #1976d2;
        }
        .station-list {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ BåŒºæ’ç­ç®¡ç†ç³»ç»Ÿ</h1>
            <p>B Zone Staffing Schedule</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showView('manager')">åº—é•¿æ’ç­</div>
            <div class="tab" onclick="showView('employee')">å‘˜å·¥æŸ¥çœ‹</div>
        </div>

        <!-- Manager View -->
        <div id="managerView" class="view active">
            <div class="card">
                <h2>ğŸ“… åŸºæœ¬ä¿¡æ¯</h2>
                <div class="form-group">
                    <label>æ’ç­æ—¥æœŸ</label>
                    <input type="date" id="scheduleDate" value="2026-02-05">
                </div>
                <div class="form-group">
                    <label>æ—¥æœŸç±»å‹</label>
                    <select id="dayType">
                        <option value="weekday">å·¥ä½œæ—¥ (17äºº)</option>
                        <option value="weekend">å‘¨æœ«/èŠ‚å‡æ—¥ (24äºº)</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ‘¥ äººå‘˜çŠ¶æ€ (ç‚¹å‡»åˆ‡æ¢ï¼šæ­£å¸¸ â†’ ç—…å‡ â†’ ä¼‘å‡)</h2>
                <h4 style="margin-top:15px;">Aç­ (å…¨èŒ)</h4>
                <div class="staff-grid" id="groupA"></div>
                <h4 style="margin-top:15px;">Bç­ (å…¨èŒ)</h4>
                <div class="staff-grid" id="groupB"></div>
                <h4 style="margin-top:15px;">Cç­ (å…¼èŒ)</h4>
                <div class="staff-grid" id="groupC"></div>
                <h4 style="margin-top:15px;">Dç­ (å…¼èŒ)</h4>
                <div class="staff-grid" id="groupD"></div>
                <h4 style="margin-top:15px;">Eç­ (å…¼èŒ)</h4>
                <div class="staff-grid" id="groupE"></div>
            </div>

            <div class="card">
                <h2>ğŸ‘” ç®¡ç†å±‚é…ç½®</h2>
                <div class="form-group">
                    <label>æ—©ç­DUTY</label>
                    <select id="morningDuty" onchange="updateEveningOptions()">
                        <option value="é™ˆé›ªè²">é™ˆé›ªè²</option>
                        <option value="å¼ æ™Ÿæ¥">å¼ æ™Ÿæ¥</option>
                        <option value="èµµæ¬£">èµµæ¬£</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ™šç­DUTY</label>
                    <select id="eveningDuty">
                        <option value="èµµæ¬£">èµµæ¬£</option>
                        <option value="é™ˆé›ªè²">é™ˆé›ªè²</option>
                        <option value="å¼ æ™Ÿæ¥">å¼ æ™Ÿæ¥</option>
                    </select>
                </div>
            </div>

            <div class="card" style="text-align:center;">
                <button class="btn" onclick="generate()">ğŸš€ ç”Ÿæˆæ’ç­è¡¨</button>
                <button class="btn btn-secondary" onclick="reset()">é‡ç½®</button>
            </div>

            <div id="scheduleOutput"></div>
        </div>

        <!-- Employee View -->
        <div id="employeeView" class="view">
            <div class="card" style="text-align:center;">
                <h2>ğŸ“± æˆ‘çš„æ’ç­</h2>
                <div class="form-group" style="max-width:300px;margin:30px auto;">
                    <select id="employeeSelect">
                        <option value="">-- é€‰æ‹©æ‚¨çš„å§“å --</option>
                    </select>
                </div>
                <button class="btn" onclick="viewPersonalSchedule()">æŸ¥çœ‹æˆ‘çš„æ’ç­</button>
                <div id="personalSchedule"></div>
            </div>
        </div>
    </div>

    <script>
        // Data - Updated with shift groups and part-time indicators
        const staffDB = {
            'Aç­': ['å¼ ä¸€æ˜', 'ç‹æ–Œå¤', 'å¼ ç¨‹ä¿Š', 'å¼ ä¹ƒèŠ', 'æ¨æ—º', 'é™ˆæ³½å®', 'äºçª', 'æ¶‚ä¸½ç²'],
            'Bç­': ['è™ç¨³å½¬', 'å¼ åº·', 'æå˜‰æ¬£', 'éƒ­å˜‰è¯š', 'æœéœ‡', 'ç½—æ™“ç‡•', 'æ²ˆæ˜ç¾½'],
            'Cç­': ['ç‹å³°', 'é™ˆç', 'å‘¨è…¾é£', 'æ²ˆæ€è¾°', 'å¼ ä¸€é¸£'],
            'Dç­': ['ç”˜æ¾', 'é¾šå„’é¦¨', 'æœ±ç››ç¥º', 'é«˜ç‘æ˜‚', 'æä½³éœ–', 'å§šé™å®œ', 'æ´ªç‘¾', 'å¼ æ€å½¤'],
            'Eç­': ['æ¢æ™¯ç„±', 'ç››å®¶è´º', 'å•æ·¼', 'èµµæ€æ¶µ', 'äºæµ©ç„¶']
        };

        const shiftGroups = {
            'Aç­': { hours: '9:00-18:00', type: 'fulltime' },
            'Bç­': { hours: '13:30-22:30', type: 'fulltime' },
            'Cç­': { hours: '10:00-19:00', type: 'parttime' },
            'Dç­': { hours: '11:00-20:00', type: 'parttime' },
            'Eç­': { hours: '12:00-21:00', type: 'parttime' }
        };

        const skills = {
            'å¼ ä¸€æ˜': ['OMNI', 'æ‰‹ä½œ', 'ä¸»æœº'],
            'ç‹æ–Œå¤': ['ä¿é¾„çƒ', 'OMNI', 'å°„å‡»'],
            'å¼ ä¹ƒèŠ': ['OMNI', 'æ‰‹ä½œ', 'ä¸»æœº'],
            'é¾šå„’é¦¨': ['OMNI', 'DBOX', 'æ²™ç›˜èµ›è½¦'],
            'ç”˜æ¾': ['ç¿¼è£…é£è¡Œ', 'OMNI', 'æ»‘é›ªæœº'],
            'æœéœ‡': ['çš®åˆ’è‰‡', 'å°„å‡»', 'å°„ç®­'],
            'äºæµ©ç„¶': ['DBOX', 'æ²™ç›˜èµ›è½¦', 'ä¿é¾„çƒ'],
            'å¼ åº·': ['OMNI', 'å°„å‡»', 'çš®åˆ’è‰‡'],
            'æå˜‰æ¬£': ['æ‰‹ä½œ', 'å°„å‡»', 'ä¿é¾„çƒ'],
            'æ¢æ™¯ç„±': ['ä¿é¾„çƒ', 'OMNI', 'é£é•–'],
            'è™ç¨³å½¬': ['ä¿é¾„çƒ', 'æ²™ç›˜èµ›è½¦', 'ç¿¼è£…é£è¡Œ'],
            'ç½—æ™“ç‡•': ['ä¿é¾„çƒ', 'çš®åˆ’è‰‡', 'æ»‘é›ªæœº'],
            'å¼ è¯—æ™—': ['ç¿¼è£…é£è¡Œ', 'æ»‘é›ªæœº', 'å†²æµªæ¿'],
            'é‡‘è¶Š': ['æœºåŠ¨']
        };

        const stations = ['OMNI', 'MF', 'DBOX', 'æ²™ç›˜èµ›è½¦', 'ç¿¼è£…é£è¡Œ', 'ä¿é¾„çƒ', 
                         'é£é•–', 'å°„å‡»', 'å°„ç®­', 'æ»‘é›ªæœº', 'çš®åˆ’è‰‡', 'å†²æµªæ¿', 'ä¸»æœº', 'æ‰‹ä½œ'];

        let staffStatus = {};
        let currentSchedule = null;

        // Initialize
        function init() {
            renderStaff();
            populateEmployees();
            updateEveningOptions();
        }

        function renderStaff() {
            Object.keys(staffDB).forEach(group => {
                const container = document.getElementById('group' + group.replace('ç­', ''));
                container.innerHTML = staffDB[group].map(name => `
                    <div class="staff-item selected" data-name="${name}" onclick="toggleStatus('${name}')">
                        <input type="checkbox" checked>
                        <label>${name} ${shiftGroups[group].type === 'parttime' ? '<span class="badge-parttime">(å…¼)</span>' : ''}</label>
                    </div>
                `).join('');
            });
        }

        function toggleStatus(name) {
            const el = document.querySelector(`[data-name="${name}"]`);
            const checkbox = el.querySelector('input');
            
            // Cycle: normal -> sick -> vacation -> normal
            if (!el.classList.contains('sick') && !el.classList.contains('vacation')) {
                el.classList.remove('selected');
                el.classList.add('sick');
                checkbox.checked = false;
                staffStatus[name] = 'sick';
            } else if (el.classList.contains('sick')) {
                el.classList.remove('sick');
                el.classList.add('vacation');
                checkbox.checked = false;
                staffStatus[name] = 'vacation';
            } else {
                el.classList.remove('vacation');
                el.classList.add('selected');
                checkbox.checked = true;
                staffStatus[name] = 'normal';
            }
        }

        function updateEveningOptions() {
            const morning = document.getElementById('morningDuty').value;
            const evening = document.getElementById('eveningDuty');
            
            Array.from(evening.options).forEach(opt => {
                opt.disabled = (opt.value === morning);
            });
            
            if (evening.value === morning) {
                evening.value = Array.from(evening.options).find(o => !o.disabled).value;
            }
        }

        function generate() {
            try {
                const date = document.getElementById('scheduleDate').value;
                const dayType = document.getElementById('dayType').value;
                const morningDuty = document.getElementById('morningDuty').value;
                const eveningDuty = document.getElementById('eveningDuty').value;

                if (morningDuty === eveningDuty) {
                    alert('æ—©ç­å’Œæ™šç­DUTYä¸èƒ½æ˜¯åŒä¸€ä¸ªäººï¼');
                    return;
                }

                // Get available staff by group
                const availableByGroup = {};
                Object.keys(staffDB).forEach(group => {
                    availableByGroup[group] = staffDB[group]
                        .filter(name => staffStatus[name] !== 'sick' && staffStatus[name] !== 'vacation')
                        .map(name => ({name, group, skills: skills[name] || ['æœºåŠ¨']}));
                });

                // Generate schedule with proper shift groups and breaks
                currentSchedule = buildAdvancedSchedule(availableByGroup, dayType, morningDuty, eveningDuty, date);
                
                // Display
                displaySchedule(currentSchedule);
                
                // Save
                localStorage.setItem('schedule_' + date, JSON.stringify(currentSchedule));
                
            } catch (err) {
                alert('é”™è¯¯: ' + err.message);
                console.error(err);
            }
        }

        function buildAdvancedSchedule(availableByGroup, dayType, morningDuty, eveningDuty, date) {
            const allStaff = Object.values(availableByGroup).flat();
            if (allStaff.length === 0) {
                throw new Error('æ²¡æœ‰å¯ç”¨çš„å‘˜å·¥ï¼');
            }

            // Define time slots with properly staggered breaks
            const timeSlots = [
                { time: '9:00-10:00', type: 'opening' },
                { time: '10:00-11:00', type: 'normal' },
                { time: '11:00-12:00', type: 'normal' },
                { time: '12:00-13:30', type: 'normal' }, // Aç­å·¥ä½œï¼ŒBç­æœªå¼€å§‹
                { time: '13:30-14:30', type: 'lunch_break_A', description: 'åˆé¤ä¼‘æ¯ (Aç­ 1:30-2:30PM)' },
                { time: '14:30-16:00', type: 'normal' },
                { time: '16:00-17:00', type: 'dinner_break_B', description: 'æ™šé¤ä¼‘æ¯ (Bç­ 4-5PM)' },
                { time: '17:00-18:00', type: 'dinner_break_C', description: 'æ™šé¤ä¼‘æ¯ (Cç­ 5-6PM)' },
                { time: '18:00-19:00', type: 'normal' },
                { time: '19:00-20:00', type: 'normal' },
                { time: '20:00-21:00', type: 'normal' },
                { time: '21:00-22:00', type: 'normal' },
                { time: '22:00-22:30', type: 'closing' }
            ];

            // Group assignments by shift
            const shiftAssignments = {};
            const detailedAssignments = {};

            // Track who takes which break to ensure one break per person
            const breakAssignments = {
                lunch: [], // Aç­ lunch break
                dinner_B: [], // Bç­ dinner break  
                dinner_C: [], // Cç­ dinner break
                dinner_D: [], // Dç­ dinner break
                dinner_E: []  // Eç­ dinner break
            };

            // Assign staff to time slots based on their group with staggered breaks
            timeSlots.forEach(slot => {
                const slotAssignments = [];
                
                // Determine which groups should work this slot (considering staggered breaks)
                const availableGroups = [];
                const onBreakGroups = [];
                const coveringStaff = []; // Track who is covering during breaks
                
                Object.keys(availableByGroup).forEach(group => {
                    const groupInfo = shiftGroups[group];
                    const [startHour, endHour] = groupInfo.hours.split('-').map(t => parseInt(t));
                    const currentHour = parseInt(slot.time.split(':')[0]);
                    
                    // Check if group works this hour
                    if (currentHour >= startHour && currentHour < endHour) {
                        // Handle staggered breaks - assign specific people to breaks
                        if (slot.type === 'lunch_break_A' && group === 'Aç­') {
                            // Aç­åˆé¤ä¼‘æ¯ - 1:30-2:30PM
                            if (breakAssignments.lunch.length === 0) {
                                // Assign Aç­äººå‘˜ to lunch break (first batch)
                                const lunchTakers = availableByGroup['Aç­'].slice(0, Math.ceil(availableByGroup['Aç­'].length / 2));
                                breakAssignments.lunch = lunchTakers.map(p => p.name);
                            }
                            onBreakGroups.push({group: group, breakType: 'lunch', people: breakAssignments.lunch});
                            return;
                        }
                        if (slot.type === 'dinner_break_B' && group === 'Bç­') {
                            // Bç­æ™šé¤ä¼‘æ¯ - 4-5PM
                            if (breakAssignments.dinner_B.length === 0) {
                                breakAssignments.dinner_B = availableByGroup['Bç­'].map(p => p.name);
                            }
                            onBreakGroups.push({group: group, breakType: 'dinner_B', people: breakAssignments.dinner_B});
                            return;
                        }
                        if (slot.type === 'dinner_break_C' && group === 'Cç­') {
                            // Cç­æ™šé¤ä¼‘æ¯ - 5-6PM  
                            if (breakAssignments.dinner_C.length === 0) {
                                breakAssignments.dinner_C = availableByGroup['Cç­'].map(p => p.name);
                            }
                            onBreakGroups.push({group: group, breakType: 'dinner_C', people: breakAssignments.dinner_C});
                            return;
                        }
                        availableGroups.push(group);
                    }
                });

                // For Dç­ and Eç­, assign dinner breaks to specific individuals, not whole groups
                if (slot.type === 'dinner_break_B' || slot.type === 'dinner_break_C') {
                    // Find people who haven't taken lunch break yet for dinner breaks
                    const availableForDinner = [];
                    ['Dç­', 'Eç­'].forEach(group => {
                        if (availableByGroup[group]) {
                            availableByGroup[group].forEach(person => {
                                // Only assign to dinner if they haven't taken lunch
                                if (!breakAssignments.lunch.includes(person.name)) {
                                    if (slot.type === 'dinner_break_B' && breakAssignments.dinner_D.length < Math.ceil(availableByGroup['Dç­'].length / 2)) {
                                        if (!breakAssignments.dinner_D.includes(person.name)) {
                                            breakAssignments.dinner_D.push(person.name);
                                        }
                                    } else if (slot.type === 'dinner_break_C' && breakAssignments.dinner_E.length < Math.ceil(availableByGroup['Eç­'].length / 2)) {
                                        if (!breakAssignments.dinner_E.includes(person.name)) {
                                            breakAssignments.dinner_E.push(person.name);
                                        }
                                    }
                                }
                            });
                        }
                    });
                }

                // Assign stations to available staff (ensuring coverage during breaks)
                const availableStaff = availableGroups.flatMap(group => availableByGroup[group]);
                
                stations.forEach((station, stationIdx) => {
                    const qualified = availableStaff.filter(s => s.skills && s.skills.includes(station));
                    if (qualified.length > 0) {
                        const person = qualified[stationIdx % qualified.length];
                        slotAssignments.push({station, staff: person.name, group: person.group});
                        
                        // Store detailed assignment
                        if (!detailedAssignments[person.name]) detailedAssignments[person.name] = [];
                        
                        // Avoid duplicates by checking if this time slot already exists
                        const existingAssignment = detailedAssignments[person.name].find(a => a.time === slot.time);
                        if (!existingAssignment) {
                            detailedAssignments[person.name].push({
                                time: slot.time,
                                type: slot.type,
                                station: station,
                                group: person.group,
                                onBreak: false
                            });
                        }
                    }
                });

                // Mark break assignments for personal view with detailed info
                onBreakGroups.forEach(breakInfo => {
                    breakInfo.people.forEach(personName => {
                        if (!detailedAssignments[personName]) detailedAssignments[personName] = [];
                        
                        // Avoid duplicates
                        const existingBreak = detailedAssignments[personName].find(a => a.time === slot.time && a.onBreak);
                        if (!existingBreak) {
                            detailedAssignments[personName].push({
                                time: slot.time,
                                type: slot.type,
                                station: null,
                                group: breakInfo.group,
                                onBreak: true,
                                breakDescription: slot.description || 'ä¼‘æ¯æ—¶é—´',
                                coveringGroups: availableGroups.join(', ') // Show who is covering
                            });
                        }
                    });
                });

                shiftAssignments[slot.time] = slotAssignments;
            });

            // Build HTML output
            let html = '<div class="card"><h2>ğŸ“‹ æ’ç­è¡¨ - ' + date + '</h2>';
            html += '<div class="shift-group-info">';
            html += '<p><strong>ç±»å‹:</strong> ' + (dayType === 'weekend' ? 'å‘¨æœ«/èŠ‚å‡æ—¥' : 'å·¥ä½œæ—¥') + '</p>';
            html += '<p><strong>æ—©ç­DUTY:</strong> <span class="badge badge-duty">' + morningDuty + '</span> | <strong>æ™šç­DUTY:</strong> <span class="badge badge-duty">' + eveningDuty + '</span></p>';
            html += '<p><strong>æ—©ç­è´Ÿè´£äºº:</strong> é‡‘è¶Š | <strong>æ™šç­è´Ÿè´£äºº:</strong> å¼ è¯—æ™—</p>';
            html += '<p><strong>é¥®æ–™æœºç›˜ç‚¹:</strong> ' + allStaff[0].name + ' | <strong>å¨ƒå¨ƒæœºç›˜ç‚¹:</strong> ' + (allStaff[1]?.name || allStaff[0].name) + '</p>';
            html += '</div>';
            
            html += '<table><thead><tr><th>æ—¶é—´</th><th>ä»»åŠ¡/å²—ä½</th><th>äººå‘˜</th><th>ç­ç»„</th></tr></thead><tbody>';
            
            timeSlots.forEach(slot => {
                const assignments = shiftAssignments[slot.time] || [];
                
                if (slot.type === 'opening') {
                    html += '<tr><td class="time-slot">' + slot.time + '</td>';
                    html += '<td><span class="badge badge-cleaning">å¼€æ¡£æ¸…æ´</span><br><small>æ²™ç›˜èµ›è½¦,æ‹ç…§æœº,MF,æ´¾å¯¹æˆ¿</small></td>';
                    html += '<td>' + assignments.slice(0, 4).map(a => a.staff).join(', ') + '</td>';
                    html += '<td>' + assignments.slice(0, 4).map(a => a.group).join(', ') + '</td></tr>';
                } else if (slot.type === 'lunch_break_A') {
                    html += '<tr><td class="time-slot">' + slot.time + '</td>';
                    html += '<td><span class="badge badge-break">åˆé¤ä¼‘æ¯</span><br><small>Aç­ä¼‘æ¯ï¼ŒBç­æ¥ç®¡è®¾å¤‡</small></td>';
                    html += '<td>' + assignments.map(a => a.station + ': ' + a.staff).join('<br>') + '</td>';
                    html += '<td>' + [...new Set(assignments.map(a => a.group))].join(', ') + '</td></tr>';
                } else if (slot.type === 'dinner_break_B') {
                    html += '<tr><td class="time-slot">' + slot.time + '</td>';
                    html += '<td><span class="badge badge-break">æ™šé¤ä¼‘æ¯</span><br><small>Bç­ä¼‘æ¯ï¼ŒA/C/D/Eç­è¦†ç›–</small></td>';
                    html += '<td>' + assignments.map(a => a.station + ': ' + a.staff).join('<br>') + '</td>';
                    html += '<td>' + [...new Set(assignments.map(a => a.group))].join(', ') + '</td></tr>';
                } else if (slot.type === 'dinner_break_C') {
                    html += '<tr><td class="time-slot">' + slot.time + '</td>';
                    html += '<td><span class="badge badge-break">æ™šé¤ä¼‘æ¯</span><br><small>C/D/Eç­éƒ¨åˆ†ä¼‘æ¯ï¼ŒA/Bç­è¦†ç›–</small></td>';
                    html += '<td>' + assignments.map(a => a.station + ': ' + a.staff).join('<br>') + '</td>';
                    html += '<td>' + [...new Set(assignments.map(a => a.group))].join(', ') + '</td></tr>';
                } else if (slot.type === 'closing') {
                    html += '<tr><td class="time-slot">' + slot.time + '</td>';
                    html += '<td><span class="badge badge-cleaning">é—­æ¡£æ¸…æ´</span><br><small>çš®åˆ’è‰‡,æ»‘é›ªæœº,å†²æµªæ¿,ä¿é¾„çƒ</small></td>';
                    html += '<td>' + assignments.slice(0, 4).map(a => a.staff).join(', ') + '</td>';
                    html += '<td>' + assignments.slice(0, 4).map(a => a.group).join(', ') + '</td></tr>';
                } else if (assignments.length > 0) {
                    html += '<tr><td class="time-slot">' + slot.time + '</td>';
                    html += '<td>å²—ä½å€¼ç­</td>';
                    html += '<td>' + assignments.map(a => a.station + ': ' + a.staff).join('<br>') + '</td>';
                    html += '<td>' + [...new Set(assignments.map(a => a.group))].join(', ') + '</td></tr>';
                }
            });
            
            html += '</tbody></table>';
            
            // Add shift group summary
            html += '<div class="shift-group-info">';
            html += '<h3>ğŸ“‹ ç­ç»„å®‰æ’</h3>';
            Object.keys(availableByGroup).forEach(group => {
                if (availableByGroup[group].length > 0) {
                    html += '<p><strong>' + group + '</strong> (' + shiftGroups[group].hours + '): ' + 
                           availableByGroup[group].map(s => s.name).join(', ') + '</p>';
                }
            });
            html += '<p><strong>ğŸ’¡ ä¼‘æ¯å®‰æ’:</strong> Aç­1:30-2:30PMåˆé¤ï¼ŒBç­4-5PMæ™šé¤ï¼ŒCç­5-6PMæ™šé¤ï¼ŒD/Eç­åˆ†æ‰¹æ™šé¤</p>';
            html += '</div>';
            
            // Share link
            html += '<div class="share-box">';
            html += '<h3>ğŸ”— å‘˜å·¥æŸ¥çœ‹é“¾æ¥</h3>';
            html += '<p>å¤åˆ¶æ­¤é“¾æ¥å‘é€ç»™å‘˜å·¥æŸ¥çœ‹ä¸ªäººæ’ç­</p>';
            html += '<input type="text" value="' + window.location.href + '?view=employee&date=' + date + '" readonly onclick="this.select()">';
            html += '</div></div>';
            
            return {
                date, 
                dayType, 
                morningDuty, 
                eveningDuty, 
                staff: allStaff.map(s => s.name), 
                html,
                detailedAssignments,
                shiftGroups: availableByGroup
            };
        }

        function displaySchedule(schedule) {
            document.getElementById('scheduleOutput').innerHTML = schedule.html;
            document.getElementById('scheduleOutput').scrollIntoView({behavior: 'smooth'});
        }

        function reset() {
            staffStatus = {};
            renderStaff();
            document.getElementById('scheduleOutput').innerHTML = '';
        }

        function showView(view) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(view + 'View').classList.add('active');
        }

        function populateEmployees() {
            const allStaff = [];
            Object.values(staffDB).forEach(g => allStaff.push(...g));
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">-- é€‰æ‹©å§“å --</option>' + 
                [...new Set(allStaff)].sort().map(n => '<option value="' + n + '">' + n + '</option>').join('');
        }

        function viewPersonalSchedule() {
            const name = document.getElementById('employeeSelect').value;
            if (!name) { alert('è¯·é€‰æ‹©å§“å'); return; }
            
            const date = document.getElementById('scheduleDate').value;
            const schedule = JSON.parse(localStorage.getItem('schedule_' + date) || '{}');
            
            if (!schedule || !schedule.staff || !schedule.staff.includes(name)) {
                document.getElementById('personalSchedule').innerHTML = '<p style="margin-top:20px;color:#666;">ä»Šæ—¥æš‚æ— æ‚¨çš„æ’ç­ä¿¡æ¯</p>';
                return;
            }
            
            // Generate personal view with detailed schedule including staggered breaks
            let html = '<div style="margin-top:30px;text-align:left;">';
            html += '<h3>' + name + ' - ' + date + ' æ’ç­</h3>';
            
            if (schedule.detailedAssignments && schedule.detailedAssignments[name]) {
                const assignments = schedule.detailedAssignments[name];
                assignments.forEach(assignment => {
                    html += '<div class="schedule-item">';
                    html += '<div class="schedule-time">' + assignment.time + '</div>';
                    
                    if (assignment.type === 'opening') {
                        html += '<div><strong>å¼€æ¡£æ¸…æ´</strong><br><small>æ²™ç›˜èµ›è½¦,æ‹ç…§æœº,MF,æ´¾å¯¹æˆ¿</small></div>';
                    } else if (assignment.type === 'closing') {
                        html += '<div><strong>é—­æ¡£æ¸…æ´</strong><br><small>çš®åˆ’è‰‡,æ»‘é›ªæœº,å†²æµªæ¿,ä¿é¾„çƒ</small></div>';
                    } else if (assignment.onBreak) {
                        // Show break with description
                        html += '<div><strong>' + assignment.breakDescription + '</strong><br><small>ä¼‘æ¯æ—¶é—´</small></div>';
                    } else if (assignment.type.includes('normal')) {
                        // Regular station assignment
                        html += '<div><strong>å²—ä½å€¼ç­</strong><br><small>' + assignment.station + '</small></div>';
                    }
                    
                    html += '</div>';
                });
            } else {
                // Fallback
                html += '<div class="schedule-item"><div class="schedule-time">9:00-10:00</div><div>å¼€æ¡£æ¸…æ´</div></div>';
                html += '<div class="schedule-item"><div class="schedule-time">10:00-13:30</div><div>å²—ä½å€¼ç­</div></div>';
                html += '<div class="schedule-item"><div class="schedule-time">13:30-14:30</div><div>ä¼‘æ¯/åƒé¥­</div></div>';
                html += '<div class="schedule-item"><div class="schedule-time">14:30-18:00</div><div>å²—ä½å€¼ç­</div></div>';
                html += '<div class="schedule-item"><div class="schedule-time">18:00-22:00</div><div>å²—ä½å€¼ç­</div></div>';
                html += '<div class="schedule-item"><div class="schedule-time">22:00-22:30</div><div>é—­æ¡£æ¸…æ´</div></div>';
            }
            
            html += '</div>';
            
            document.getElementById('personalSchedule').innerHTML = html;
        }

        // Check URL params for employee view
        if (location.search.includes('view=employee')) {
            showView('employee');
            document.querySelector('.tab.active').classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
        }

        init();
    </script>
</body>
</html>
