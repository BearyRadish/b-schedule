<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BåŒºæ’ç­ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        input[type="date"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .staff-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .staff-item:hover {
            background: #e8e8e8;
        }
        .staff-item.selected {
            background: #667eea;
            color: white;
        }
        .staff-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        .staff-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }
        .staff-item.absent {
            opacity: 0.5;
            background: #ffebee;
        }
        .staff-item.vacation {
            opacity: 0.5;
            background: #fff3e0;
        }
        .btn {
            display: inline-block;
            padding: 14px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            margin-left: 10px;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .schedule-output {
            margin-top: 30px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .time-slot {
            font-weight: 600;
            color: #667eea;
        }
        .share-link {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .share-link input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-duty {
            background: #e3f2fd;
            color: #1976d2;
        }
        .badge-inventory {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        .badge-cleaning {
            background: #e8f5e9;
            color: #388e3c;
        }
        .hidden {
            display: none;
        }
        .employee-view {
            text-align: center;
            padding: 40px;
        }
        .employee-selector {
            margin: 30px 0;
        }
        .schedule-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: left;
        }
        .schedule-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .schedule-time {
            font-weight: 600;
            color: #667eea;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Manager View -->
        <div id="managerView">
            <div class="header">
                <h1>ğŸ¢ BåŒºæ’ç­ç®¡ç†ç³»ç»Ÿ</h1>
                <p>Store Manager Dashboard - åº—é•¿ç®¡ç†åå°</p>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('manager')">åº—é•¿æ’ç­</div>
                <div class="tab" onclick="switchTab('employee')">å‘˜å·¥æŸ¥çœ‹</div>
            </div>

            <div class="card">
                <h2>ğŸ“… åŸºæœ¬ä¿¡æ¯</h2>
                <div class="form-group">
                    <label>æ’ç­æ—¥æœŸ</label>
                    <input type="date" id="scheduleDate" value="2026-02-05">
                </div>
                <div class="form-group">
                    <label>æ—¥æœŸç±»å‹</label>
                    <select id="dayType">
                        <option value="weekday">å·¥ä½œæ—¥ (17äººé…ç½®)</option>
                        <option value="weekend">å‘¨æœ«/èŠ‚å‡æ—¥ (24äººé…ç½®)</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ‘¥ äººå‘˜çŠ¶æ€ç®¡ç†</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    ç‚¹å‡»æ ‡è®°äººå‘˜çŠ¶æ€ï¼šæ­£å¸¸å‡ºå‹¤ âœ… | è¯·å‡/ä¼‘å‡ ğŸ–ï¸ | ç—…å‡ ğŸ¤’
                </p>
                
                <h3 style="margin: 20px 0 10px; color: #333;">Aç­äººå‘˜</h3>
                <div class="staff-grid" id="groupA"></div>

                <h3 style="margin: 20px 0 10px; color: #333;">Bç­äººå‘˜</h3>
                <div class="staff-grid" id="groupB"></div>

                <h3 style="margin: 20px 0 10px; color: #333;">Cç­äººå‘˜</h3>
                <div class="staff-grid" id="groupC"></div>

                <h3 style="margin: 20px 0 10px; color: #333;">Dç­äººå‘˜</h3>
                <div class="staff-grid" id="groupD"></div>

                <h3 style="margin: 20px 0 10px; color: #333;">Eç­äººå‘˜</h3>
                <div class="staff-grid" id="groupE"></div>
            </div>

            <div class="card">
                <h2>ğŸ‘” ç®¡ç†å±‚é…ç½®</h2>
                <div class="form-group">
                    <label>æ—©ç­DUTY</label>
                    <select id="morningDuty" onchange="updateEveningDutyOptions()">
                        <option value="é™ˆé›ªè²">é™ˆé›ªè² (ä¸»è¦)</option>
                        <option value="å¼ æ™Ÿæ¥">å¼ æ™Ÿæ¥</option>
                        <option value="èµµæ¬£">èµµæ¬£</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ™šç­DUTY</label>
                    <select id="eveningDuty">
                        <option value="é™ˆé›ªè²">é™ˆé›ªè²</option>
                        <option value="èµµæ¬£" selected>èµµæ¬£ (ä¸»è¦)</option>
                        <option value="å¼ æ™Ÿæ¥">å¼ æ™Ÿæ¥</option>
                    </select>
                </div>
            </div>

            <div class="card" style="text-align: center;">
                <button class="btn" onclick="generateSchedule()">ğŸš€ ç”Ÿæˆæ’ç­è¡¨</button>
                <button class="btn btn-secondary" onclick="resetForm()">é‡ç½®</button>
            </div>

            <div id="scheduleResult" class="hidden">
                <div class="card">
                    <h2>ğŸ“‹ ç”Ÿæˆç»“æœ</h2>
                    <div id="scheduleTable"></div>
                    
                    <div class="share-link">
                        <h3>ğŸ”— å‘˜å·¥æŸ¥çœ‹é“¾æ¥</h3>
                        <p>å¤åˆ¶æ­¤é“¾æ¥å‘é€ç»™å‘˜å·¥ï¼Œå‘˜å·¥å¯é€‰æ‹©è‡ªå·±çš„åå­—æŸ¥çœ‹å½“æ—¥æ’ç­</p>
                        <input type="text" id="shareLink" readonly onclick="this.select()">
                        <button class="btn" style="margin-top: 10px;" onclick="copyLink()">å¤åˆ¶é“¾æ¥</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee View -->
        <div id="employeeView" class="hidden">
            <div class="header">
                <h1>ğŸ“± æˆ‘çš„æ’ç­</h1>
                <p>Employee Schedule View - å‘˜å·¥ä¸ªäººæ’ç­æŸ¥çœ‹</p>
            </div>

            <div class="card employee-view">
                <h2>è¯·é€‰æ‹©æ‚¨çš„å§“å</h2>
                <div class="employee-selector">
                    <select id="employeeSelect" style="width: 300px; max-width: 100%;">
                        <option value="">-- é€‰æ‹©å§“å --</option>
                    </select>
                </div>
                <button class="btn" onclick="viewMySchedule()">æŸ¥çœ‹æˆ‘çš„æ’ç­</button>
                
                <div id="mySchedule" class="hidden">
                    <div class="schedule-card">
                        <h3 id="myScheduleTitle"></h3>
                        <div id="myScheduleContent"></div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="switchTab('manager')">è¿”å›åº—é•¿åå°</button>
            </div>
        </div>
    </div>

    <script>
        // Staff database based on the analysis
        const staffDB = {
            Aç­: ['å¼ ä¸€æ˜', 'ç‹æ–Œå¤', 'å¼ ç¨‹ä¿Š', 'å¼ ä¹ƒèŠ', 'æ¨æ—º', 'é™ˆæ³½å®', 'äºçª', 'æ¶‚ä¸½ç²'],
            Bç­: ['è™ç¨³å½¬', 'å¼ åº·', 'æå˜‰æ¬£', 'éƒ­å˜‰è¯š', 'æœéœ‡', 'ç½—æ™“ç‡•', 'æ²ˆæ˜ç¾½'],
            Cç­: ['ç‹å³°', 'é™ˆç', 'å‘¨è…¾é£', 'æ²ˆæ€è¾°', 'å¼ ä¸€é¸£'],
            Dç­: ['ç”˜æ¾', 'é¾šå„’é¦¨', 'æœ±ç››ç¥º', 'é«˜ç‘æ˜‚', 'æä½³éœ–', 'å§šé™å®œ', 'æ´ªç‘¾', 'å¼ æ€å½¤'],
            Eç­: ['æ¢æ™¯ç„±', 'ç››å®¶è´º', 'å•æ·¼', 'èµµæ€æ¶µ', 'äºæµ©ç„¶']
        };

        // Station assignments based on analysis
        const stationSkills = {
            'å¼ ä¸€æ˜': ['OMNI', 'æ‰‹ä½œ', 'ä¸»æœº'],
            'ç‹æ–Œå¤': ['ä¿é¾„çƒ', 'OMNI', 'å°„å‡»'],
            'å¼ ä¹ƒèŠ': ['OMNI', 'æ‰‹ä½œ', 'ä¸»æœº'],
            'é¾šå„’é¦¨': ['OMNI', 'DBOX', 'æ²™ç›˜èµ›è½¦'],
            'ç”˜æ¾': ['ç¿¼è£…é£è¡Œ', 'OMNI', 'æ»‘é›ªæœº'],
            'æœéœ‡': ['çš®åˆ’è‰‡', 'å°„å‡»', 'å°„ç®­'],
            'äºæµ©ç„¶': ['DBOX', 'æ²™ç›˜èµ›è½¦', 'ä¿é¾„çƒ'],
            'å¼ åº·': ['OMNI', 'å°„å‡»', 'çš®åˆ’è‰‡'],
            'æå˜‰æ¬£': ['æ‰‹ä½œ', 'å°„å‡»', 'ä¿é¾„çƒ'],
            'æ¢æ™¯ç„±': ['ä¿é¾„çƒ', 'OMNI', 'é£é•–'],
            'è™ç¨³å½¬': ['ä¿é¾„çƒ', 'æ²™ç›˜èµ›è½¦', 'ç¿¼è£…é£è¡Œ'],
            'ç½—æ™“ç‡•': ['ä¿é¾„çƒ', 'çš®åˆ’è‰‡', 'æ»‘é›ªæœº'],
            'å¼ è¯—æ™—': ['ç¿¼è£…é£è¡Œ', 'æ»‘é›ªæœº', 'å†²æµªæ¿'],
            'é‡‘è¶Š': ['æœºåŠ¨', 'ç®¡ç†']
        };

        // Staff status tracking
        let staffStatus = {};

        // Initialize
        function init() {
            renderStaffGrid();
            populateEmployeeSelect();
            
            // Check if we're in employee view mode (from URL)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('view') === 'employee') {
                switchTab('employee');
            }
        }

        function renderStaffGrid() {
            Object.keys(staffDB).forEach(group => {
                const container = document.getElementById('group' + group.replace('ç­', ''));
                container.innerHTML = staffDB[group].map(name => `
                    <div class="staff-item selected" data-name="${name}" onclick="toggleStaffStatus(this, '${name}')">
                        <input type="checkbox" checked onchange="event.stopPropagation()">
                        <label>${name}</label>
                    </div>
                `).join('');
            });
        }

        function toggleStaffStatus(element, name) {
            const checkbox = element.querySelector('input');
            checkbox.checked = !checkbox.checked;
            
            if (!checkbox.checked) {
                // Cycle through: absent -> vacation -> normal
                if (element.classList.contains('absent')) {
                    element.classList.remove('absent');
                    element.classList.add('vacation');
                    staffStatus[name] = 'vacation';
                } else if (element.classList.contains('vacation')) {
                    element.classList.remove('vacation');
                    element.classList.remove('selected');
                    staffStatus[name] = 'off';
                } else {
                    element.classList.add('absent');
                    element.classList.remove('selected');
                    staffStatus[name] = 'sick';
                }
            } else {
                element.classList.remove('absent', 'vacation');
                element.classList.add('selected');
                staffStatus[name] = 'normal';
            }
        }

        // Store the generated schedule globally for employee view
        let currentSchedule = null;

        function updateEveningDutyOptions() {
            const morningDuty = document.getElementById('morningDuty').value;
            const eveningSelect = document.getElementById('eveningDuty');
            const options = eveningSelect.querySelectorAll('option');
            
            options.forEach(option => {
                if (option.value === morningDuty) {
                    option.disabled = true;
                    option.style.color = '#ccc';
                } else {
                    option.disabled = false;
                    option.style.color = '';
                }
            });
            
            // If currently selected evening duty is same as morning, change it
            if (eveningSelect.value === morningDuty) {
                const availableOptions = Array.from(options).filter(o => !o.disabled && o.value);
                if (availableOptions.length > 0) {
                    eveningSelect.value = availableOptions[0].value;
                }
            }
        }

        function generateSchedule() {
            const date = document.getElementById('scheduleDate').value;
            const dayType = document.getElementById('dayType').value;
            const morningDuty = document.getElementById('morningDuty').value;
            const eveningDuty = document.getElementById('eveningDuty').value;

            // Validate different people for morning and evening
            if (morningDuty === eveningDuty) {
                alert('æ—©ç­DUTYå’Œæ™šç­DUTYä¸èƒ½æ˜¯åŒä¸€ä¸ªäººï¼è¯·é€‰æ‹©ä¸åŒçš„è´Ÿè´£äººã€‚');
                return;
            }

            // Get available staff
            const availableStaff = [];
            Object.keys(staffDB).forEach(group => {
                staffDB[group].forEach(name => {
                    if (staffStatus[name] !== 'sick' && staffStatus[name] !== 'vacation' && staffStatus[name] !== 'off') {
                        availableStaff.push({ name, group, skills: stationSkills[name] || ['æœºåŠ¨'] });
                    }
                });
            });

            if (availableStaff.length === 0) {
                alert('æ²¡æœ‰å¯ç”¨çš„å‘˜å·¥ï¼è¯·æ£€æŸ¥äººå‘˜çŠ¶æ€ã€‚');
                return;
            }

            // Generate schedule based on day type
            currentSchedule = createSchedule(availableStaff, dayType, morningDuty, eveningDuty);
            
            // Display results
            displaySchedule(currentSchedule, date);
            
            // Generate share link
            const shareUrl = generateShareLink(date, currentSchedule);
            document.getElementById('shareLink').value = shareUrl;
            
            // Show result and scroll to it
            document.getElementById('scheduleResult').classList.remove('hidden');
            document.getElementById('scheduleResult').scrollIntoView({ behavior: 'smooth' });
            
            // Save to localStorage for employee view
            localStorage.setItem('currentSchedule', JSON.stringify(currentSchedule));
        }

        function createSchedule(staff, dayType, morningDuty, eveningDuty) {
            const timeSlots = [
                '9:00-10:00', '10:00-11:00', '11:00-12:00', '12:00-13:30',
                '13:30-14:30', '14:30-16:00', '16:00-17:00', '17:00-18:00',
                '18:00-19:00', '19:00-20:00', '20:00-21:00', '21:00-22:00', '22:00-22:30'
            ];

            const stations = {
                opening: ['æ²™ç›˜èµ›è½¦', 'æ‹ç…§æœº', 'MF', 'æ´¾å¯¹æˆ¿', 'OMNI', 'æ»‘é›ªæœº', 'å†²æµªæ¿', 'çš®åˆ’è‰‡', 'DBOX', 'ç¿¼è£…é£è¡Œ', 'ä¸»æœº', 'ä¿é¾„çƒ', 'é£é•–', 'å°„å‡»', 'å°„ç®­', 'æ‰‹ä½œåŒº'],
                main: ['OMNI', 'MF', 'DBOX', 'æ²™ç›˜èµ›è½¦', 'ç¿¼è£…é£è¡Œ', 'ä¿é¾„çƒ', 'é£é•–', 'å°„å‡»', 'å°„ç®­', 'æ»‘é›ªæœº', 'çš®åˆ’è‰‡', 'å†²æµªæ¿', 'ä¸»æœº', 'æ‰‹ä½œ'],
                closing: ['çš®åˆ’è‰‡', 'æ»‘é›ªæœº', 'å†²æµªæ¿', 'ä¿é¾„çƒ', 'OMNI', 'MF', 'DBOX', 'ç¿¼è£…é£è¡Œ', 'æ²™ç›˜èµ›è½¦', 'ä¸»æœº', 'æ´¾å¯¹æˆ¿', 'æ‰‹ä½œ']
            };

            // Assign staff to stations based on their skills
            const assignments = [];
            
            // Morning opening
            assignments.push({
                time: '9:00-10:00',
                type: 'opening',
                tasks: [
                    { task: 'å¼€æ¡£æ¸…æ´&æ£€æŸ¥', stations: stations.opening.slice(0, 4), staff: staff.slice(0, 3).map(s => s.name) },
                    { task: 'å¼€æ¡£æ¸…æ´', stations: stations.opening.slice(4, 8), staff: staff.slice(3, 6).map(s => s.name) },
                    { task: 'å¼€æ¡£æ¸…æ´', stations: stations.opening.slice(8, 12), staff: staff.slice(6, 9).map(s => s.name) },
                    { task: 'å¼€æ¡£æ¸…æ´', stations: stations.opening.slice(12), staff: staff.slice(9, 12).map(s => s.name) }
                ]
            });

            // Main shifts - assign based on skills
            for (let i = 1; i < timeSlots.length - 1; i++) {
                const slotAssignments = [];
                const availableForSlot = staff.filter(s => !slotAssignments.find(a => a.staff === s.name));
                
                // Assign to stations based on skills
                stations.main.forEach((station, idx) => {
                    const qualified = availableForSlot.filter(s => s.skills && s.skills.includes(station));
                    if (qualified.length > 0) {
                        const assigned = qualified[idx % qualified.length];
                        slotAssignments.push({ station, staff: assigned.name });
                    }
                });

                assignments.push({
                    time: timeSlots[i],
                    type: 'main',
                    assignments: slotAssignments
                });
            }

            // Closing
            assignments.push({
                time: '22:00-22:30',
                type: 'closing',
                tasks: [
                    { task: 'é—­æ¡£æ¸…æ´&æ£€æŸ¥', stations: stations.closing.slice(0, 4), staff: staff.slice(0, 3).map(s => s.name) },
                    { task: 'é—­æ¡£æ¸…æ´', stations: stations.closing.slice(4, 8), staff: staff.slice(3, 6).map(s => s.name) },
                    { task: 'é—­æ¡£æ¸…æ´', stations: stations.closing.slice(8, 12), staff: staff.slice(6, 9).map(s => s.name) },
                    { task: 'é—­æ¡£æ¸…æ´', stations: stations.closing.slice(12), staff: staff.slice(9, 12).map(s => s.name) }
                ]
            });

            return {
                date: document.getElementById('scheduleDate').value,
                dayType,
                morningDuty,
                eveningDuty,
                dutyLeaders: { morning: 'é‡‘è¶Š', evening: 'å¼ è¯—æ™—' },
                inventory: {
                    drinks: staff.find(s => s.skills && s.skills.includes('ä¿é¾„çƒ'))?.name || staff[0]?.name || 'å¾…å®š',
                    claw: staff.find(s => s.group === 'Bç­')?.name || staff[1]?.name || 'å¾…å®š'
                },
                assignments
            };
        }

        function displaySchedule(schedule, date) {
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                    <p><strong>æ—¥æœŸ:</strong> ${date}</p>
                    <p><strong>ç±»å‹:</strong> ${schedule.dayType === 'weekend' ? 'å‘¨æœ«/èŠ‚å‡æ—¥' : 'å·¥ä½œæ—¥'}</p>
                    <p><strong>æ—©ç­DUTY:</strong> <span class="badge badge-duty">${schedule.morningDuty}</span></p>
                    <p><strong>æ™šç­DUTY:</strong> <span class="badge badge-duty">${schedule.eveningDuty}</span></p>
                    <p><strong>æ—©ç­è´Ÿè´£äºº:</strong> ${schedule.dutyLeaders.morning}</p>
                    <p><strong>æ™šç­è´Ÿè´£äºº:</strong> ${schedule.dutyLeaders.evening}</p>
                    <p><strong>é¥®æ–™æœºç›˜ç‚¹:</strong> <span class="badge badge-inventory">${schedule.inventory.drinks}</span></p>
                    <p><strong>å¨ƒå¨ƒæœºç›˜ç‚¹:</strong> <span class="badge badge-inventory">${schedule.inventory.claw}</span></p>
                </div>
            `;

            html += '<table>';
            html += '<thead><tr><th>æ—¶é—´</th><th>å²—ä½/ä»»åŠ¡</th><th>äººå‘˜å®‰æ’</th></tr></thead><tbody>';

            schedule.assignments.forEach(slot => {
                if (slot.type === 'opening' || slot.type === 'closing') {
                    slot.tasks.forEach(task => {
                        html += `<tr>
                            <td class="time-slot">${slot.time}</td>
                            <td><span class="badge badge-cleaning">${task.task}</span><br><small>${task.stations.join(', ')}</small></td>
                            <td>${task.staff.join(', ')}</td>
                        </tr>`;
                    });
                } else {
                    const assignments = slot.assignments || [];
                    if (assignments.length > 0) {
                        html += `<tr>
                            <td class="time-slot">${slot.time}</td>
                            <td>å²—ä½å€¼ç­</td>
                            <td>${assignments.map(a => `${a.station}: ${a.staff}`).join('<br>')}</td>
                        </tr>`;
                    }
                }
            });

            html += '</tbody></table>';
            document.getElementById('scheduleTable').innerHTML = html;
        }

        function generateShareLink(date, schedule) {
            const baseUrl = window.location.origin + window.location.pathname;
            const params = new URLSearchParams({
                view: 'employee',
                date: date,
                data: btoa(JSON.stringify(schedule))
            });
            return baseUrl + '?' + params.toString();
        }

        function copyLink() {
            const linkInput = document.getElementById('shareLink');
            linkInput.select();
            document.execCommand('copy');
            alert('é“¾æ¥å·²å¤åˆ¶ï¼');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'manager') {
                document.getElementById('managerView').classList.remove('hidden');
                document.getElementById('employeeView').classList.add('hidden');
            } else {
                document.getElementById('managerView').classList.add('hidden');
                document.getElementById('employeeView').classList.remove('hidden');
            }
        }

        function populateEmployeeSelect() {
            const select = document.getElementById('employeeSelect');
            const allStaff = [];
            Object.values(staffDB).forEach(group => allStaff.push(...group));
            
            select.innerHTML = '<option value="">-- é€‰æ‹©å§“å --</option>' + 
                [...new Set(allStaff)].sort().map(name => `<option value="${name}">${name}</option>`).join('');
        }

        function viewMySchedule() {
            const name = document.getElementById('employeeSelect').value;
            if (!name) {
                alert('è¯·é€‰æ‹©æ‚¨çš„å§“å');
                return;
            }

            // Get schedule from URL if available
            const urlParams = new URLSearchParams(window.location.search);
            const scheduleData = urlParams.get('data');
            
            let schedule = null;
            
            if (scheduleData) {
                try {
                    schedule = JSON.parse(atob(scheduleData));
                } catch (e) {
                    console.error('Failed to parse schedule from URL');
                }
            }
            
            // Fallback to localStorage
            if (!schedule) {
                const savedSchedule = localStorage.getItem('currentSchedule');
                if (savedSchedule) {
                    schedule = JSON.parse(savedSchedule);
                }
            }
            
            if (schedule) {
                displayPersonalSchedule(name, schedule);
            } else {
                // Demo schedule with the selected name
                displayDemoSchedule(name);
            }
        }
        
        function displayDemoSchedule(name) {
            document.getElementById('mySchedule').classList.remove('hidden');
            document.getElementById('myScheduleTitle').textContent = `${name} - ${new Date().toLocaleDateString('zh-CN')} æ’ç­`;
            
            // Generate personalized demo based on name
            const skills = stationSkills[name] || ['æœºåŠ¨'];
            const mainSkill = skills[0];
            
            document.getElementById('myScheduleContent').innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px;">
                    <strong>ä»Šæ—¥å²—ä½ä¸“é•¿:</strong> ${skills.join(', ')}
                </div>
                <div class="schedule-item">
                    <div class="schedule-time">9:00-10:00</div>
                    <div>å¼€æ¡£æ¸…æ´ - ${mainSkill}åŒºåŸŸå‡†å¤‡</div>
                </div>
                <div class="schedule-item">
                    <div class="schedule-time">10:00-13:30</div>
                    <div>${mainSkill} å²—ä½å€¼ç­</div>
                </div>
                <div class="schedule-item" style="border-left-color: #ff9800;">
                    <div class="schedule-time">13:30-14:30</div>
                    <div>ğŸ½ï¸ ä¼‘æ¯/åƒé¥­æ—¶é—´</div>
                </div>
                <div class="schedule-item">
                    <div class="schedule-time">14:30-18:00</div>
                    <div>${skills[1] || mainSkill} å²—ä½å€¼ç­</div>
                </div>
                <div class="schedule-item">
                    <div class="schedule-time">18:00-22:00</div>
                    <div>${skills[2] || mainSkill} å²—ä½å€¼ç­</div>
                </div>
                <div class="schedule-item" style="border-left-color: #f44336;">
                    <div class="schedule-time">22:00-22:30</div>
                    <div>é—­æ¡£æ¸…æ´ & è®¾å¤‡æ£€æŸ¥</div>
                </div>
            `;
        }

        function displayPersonalSchedule(name, schedule) {
            document.getElementById('mySchedule').classList.remove('hidden');
            document.getElementById('myScheduleTitle').textContent = `${name} - ${schedule.date || new Date().toLocaleDateString('zh-CN')} æ’ç­`;
            
            const skills = stationSkills[name] || ['æœºåŠ¨'];
            
            // Extract personal schedule from full schedule
            let personalItems = [];
            
            schedule.assignments.forEach(slot => {
                if (slot.type === 'opening' || slot.type === 'closing') {
                    slot.tasks.forEach(task => {
                        if (task.staff && task.staff.includes(name)) {
                            personalItems.push({
                                time: slot.time,
                                task: task.task,
                                detail: task.stations.join(', '),
                                type: slot.type
                            });
                        }
                    });
                } else if (slot.assignments) {
                    const myAssignments = slot.assignments.filter(a => a.staff === name);
                    myAssignments.forEach(a => {
                        personalItems.push({
                            time: slot.time,
                            task: `${a.station} å²—ä½å€¼ç­`,
                            detail: '',
                            type: 'main'
                        });
                    });
                }
            });

            // If no specific assignments found, generate based on skills
            if (personalItems.length === 0) {
                displayDemoSchedule(name);
                return;
            }

            // Add break time if not present
            const hasBreak = personalItems.some(item => item.time.includes('13:30') || item.task.includes('åƒé¥­'));
            if (!hasBreak) {
                personalItems.push({
                    time: '13:30-14:30',
                    task: 'ğŸ½ï¸ ä¼‘æ¯/åƒé¥­æ—¶é—´',
                    detail: '',
                    type: 'break'
                });
                // Sort by time
                personalItems.sort((a, b) => a.time.localeCompare(b.time));
            }

            const html = personalItems.map(item => {
                let borderColor = '#667eea';
                if (item.type === 'break') borderColor = '#ff9800';
                if (item.type === 'closing') borderColor = '#f44336';
                if (item.type === 'opening') borderColor = '#4caf50';
                
                return `
                <div class="schedule-item" style="border-left-color: ${borderColor};">
                    <div class="schedule-time">${item.time}</div>
                    <div>${item.task}</div>
                    ${item.detail ? `<small style="color: #666;">${item.detail}</small>` : ''}
                </div>
            `;
            }).join('');
            
            document.getElementById('myScheduleContent').innerHTML = html || '<p>ä»Šæ—¥æš‚æ— æ’ç­ä¿¡æ¯</p>';
        }

        function resetForm() {
            staffStatus = {};
            renderStaffGrid();
            document.getElementById('scheduleResult').classList.add('hidden');
        }

        // Initialize on load
        init();
        
        // Initialize evening duty options based on default morning duty
        updateEveningDutyOptions();
    </script>
</body>
</html>
